# ðŸ”„ ä½ç½®æƒ…å ±å‡¦ç†ã®ç°¡ç´ åŒ– - å¤‰æ›´ã‚µãƒžãƒªãƒ¼

## ðŸ“ å¤‰æ›´æ¦‚è¦

ã‚¢ãƒ—ãƒªã§ä½ç½®æƒ…å ±å‡¦ç†ãŒå®Œçµã™ã‚‹ãŸã‚ã€APIå´ã®ä½ç½®æƒ…å ±é–¢é€£ã®å‡¦ç†ã‚’å‰Šé™¤ã—ã€è¨˜éŒ²ç›®çš„ã§ã®ä½ç½®æƒ…å ±ä¿å­˜ã®ã¿ã«ç°¡ç´ åŒ–ã—ã¾ã—ãŸã€‚

## âŒ å‰Šé™¤ã•ã‚ŒãŸæ©Ÿèƒ½

### 1. **ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤**
- `src/utils/location.ts` - å®Œå…¨å‰Šé™¤
  - `validateCoordinates()` - åº§æ¨™ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  - `calculateDistance()` - è·é›¢è¨ˆç®—
  - `calculateSearchBounds()` - æ¤œç´¢ç¯„å›²è¨ˆç®—

### 2. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‰Šé™¤**
- `POST /exchanges/location/update` - ä½ç½®æƒ…å ±æ›´æ–°
- `POST /exchanges/nearby` - è¿‘ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢

### 3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤**
- `user_locations` - ä¸€æ™‚çš„ãªä½ç½®æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«
- `idx_user_locations_coords` - ä½ç½®æƒ…å ±ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

### 4. **åž‹å®šç¾©å‰Šé™¤**
- `NearbyUser` - è¿‘ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
- `NearbyUsersRequest` - è¿‘ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

### 5. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤**
- exchanges.tsã®åŽ³å¯†ãªä½ç½®æƒ…å ±ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ä½ç½®æƒ…å ±ã®å¿…é ˆãƒã‚§ãƒƒã‚¯

## âœ… ä¿æŒã•ã‚ŒãŸæ©Ÿèƒ½

### 1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ **
- `exchanges`ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½ç½®æƒ…å ±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆè¨˜éŒ²ç›®çš„ï¼‰
  - `location_name` - å ´æ‰€å
  - `latitude` - ç·¯åº¦
  - `longitude` - çµŒåº¦

### 2. **è¨˜éŒ²ç”¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**
```typescript
// æ–°ã—ã„ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
export function validateCoordinates(latitude?: number, longitude?: number): boolean {
  if (latitude === undefined || longitude === undefined) return true;
  return (
    typeof latitude === 'number' &&
    typeof longitude === 'number' &&
    latitude >= -90 && latitude <= 90 &&
    longitude >= -180 && longitude <= 180 &&
    !isNaN(latitude) && !isNaN(longitude)
  );
}
```

### 3. **è¿‘è·é›¢äº¤æ›ã®åŸºæœ¬æ©Ÿèƒ½**
- `POST /exchanges/request` - äº¤æ›ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
- `GET /exchanges/requests` - å—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆå–å¾—
- `POST /exchanges/requests/:id/respond` - ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¿œç­”

## ðŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰æ›´

### Before (APIä¸»å°Ž)
```
ã‚¢ãƒ—ãƒª â†’ APIï¼ˆä½ç½®æƒ…å ±å‡¦ç†ï¼‰ â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
       â†“
   è¿‘è·é›¢ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
   è·é›¢è¨ˆç®—
   ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
```

### After (ã‚¢ãƒ—ãƒªä¸»å°Ž)
```
ã‚¢ãƒ—ãƒªï¼ˆä½ç½®æƒ…å ±å‡¦ç†å®Œçµï¼‰ â†’ APIï¼ˆè¨˜éŒ²ã®ã¿ï¼‰ â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
                              â†“
                         äº¤æ›ãƒ‡ãƒ¼ã‚¿ä¿å­˜
```

## ðŸ’¡ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æžœ

### 1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å‘ä¸Š**
- APIå´ã®è¨ˆç®—å‡¦ç†è² è·è»½æ¸›
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®ç°¡ç´ åŒ–
- ä½ç½®æƒ…å ±ã®ä¸€æ™‚ä¿å­˜ãŒä¸è¦

### 2. **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼å¼·åŒ–**
- ä½ç½®æƒ…å ±ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã—ãªã„
- ã‚¢ãƒ—ãƒªå†…ã§ã®ã¿ä½ç½®æƒ…å ±ã‚’å‡¦ç†
- å¿…è¦ãªå ´åˆã®ã¿è¨˜éŒ²ã¨ã—ã¦ä¿å­˜

### 3. **é–‹ç™ºåŠ¹çŽ‡åŒ–**
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆã‚¢ãƒ—ãƒªï¼‰å´ã§ä½ç½®æƒ…å ±ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨åˆ¶å¾¡
- APIå´ã®è¤‡é›‘æ€§è»½æ¸›
- ãƒ‡ãƒãƒƒã‚°ã¨ãƒ†ã‚¹ãƒˆã®ç°¡ç´ åŒ–

### 4. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š**
- ä½ç½®æƒ…å ±å‡¦ç†ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ†æ•£
- ã‚µãƒ¼ãƒãƒ¼ãƒªã‚½ãƒ¼ã‚¹ã®ç¯€ç´„
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®¹é‡ã®æœ€é©åŒ–

## ðŸš€ ç§»è¡Œå¾Œã®ä½¿ç”¨æ–¹æ³•

### ã‚¢ãƒ—ãƒªå´ã§ã®å®Ÿè£…ä¾‹
```typescript
// ã‚¢ãƒ—ãƒªå´ã§ä½ç½®æƒ…å ±å‡¦ç†
const nearbyUsers = await findNearbyUsers(currentLocation, 100);
const selectedUser = await showUserSelection(nearbyUsers);

// APIå´ã«ã¯äº¤æ›çµæžœã®ã¿é€ä¿¡
await exchangeCard({
  targetUserId: selectedUser.id,
  cardId: myCardId,
  location_name: 'ã‚¤ãƒ™ãƒ³ãƒˆä¼šå ´',
  latitude: currentLocation.lat,   // è¨˜éŒ²ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  longitude: currentLocation.lon   // è¨˜éŒ²ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
});
```

## ðŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ›´æ–°**: ã‚¢ãƒ—ãƒªå´ã§ã®ä½ç½®æƒ…å ±å‡¦ç†å®Ÿè£…
2. **ãƒ†ã‚¹ãƒˆæ›´æ–°**: å‰Šé™¤ã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆå‰Šé™¤
3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**: APIä»•æ§˜æ›¸ã®æ›´æ–°
4. **ãƒ‡ãƒ—ãƒ­ã‚¤**: æ›´æ–°ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒžã¨APIã®ãƒ‡ãƒ—ãƒ­ã‚¤

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€FlockaAPIã¯ã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ã§åŠ¹çŽ‡çš„ãªæ§‹é€ ã«ãªã‚Šã€ã‚¢ãƒ—ãƒªå´ã§ã®æŸ”è»Ÿãªä½ç½®æƒ…å ±å‡¦ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚
